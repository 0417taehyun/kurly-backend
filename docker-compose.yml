version: "3"

services: 
    django:
        build: 
            context: .
            dockerfile: ./Dockerfile
        command: gunicorn kurly.wsgi:application --bind 0.0.0.0:8000
        volumes: 
            - .:/usr/src/app
        expose: 
            - "8000"
        ports:
            - "8000:8000"
        depends_on: 
            - redis
            - elasticsearch
        
    redis:
        image: redis
        command: redis-server --tcp-backlog 128
        restart: always
        privileged: true
        ports: 
            - "6379:6379"
    
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2
        container_name: elasticsearch
        environment: 
            - cluster.name=docker-cluster
            - xpack.security.enabled=false
            - discovery.type=single-node
        ulimits: 
            memlock:
                soft: -1
                hard: -1
            nofile:
                soft: 65536
                hard: 65536
        cap_add: 
            - IPC_LOCK
        volumes: 
            - elasticsearch-data:/usr/share/elasticsearch/data
        ports: 
            - "9200:9200"
            - "9300:9300"
        mem_limit: 500m
    
volumes: 
    elasticsearch-data:
        driver: local